const ss = SpreadsheetApp.getActiveSpreadsheet();
const sheet = ss.getSheets()[0];

// GET 요청: 목록 불러오기
function doGet(e) {
  // 방어 코드: 실행 버튼 클릭 시 에러 방지
  if (!e || !e.parameter) {
    return ContentService.createTextOutput("웹 앱 주소로 접속하세요.");
  }

  const action = e.parameter.action;
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  
  if (action === 'read') {
    const rows = data.map(row => {
      let obj = {};
      headers.forEach((h, i) => { 
        if(h !== 'Password') obj[h] = row[i]; 
      });
      return obj;
    }).reverse();
    return ContentService.createTextOutput(JSON.stringify(rows))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// POST 요청: 글쓰기 및 삭제
function doPost(e) {
  // URLSearchParams 방식으로 보낼 경우 e.parameter에 데이터가 담깁니다.
  const params = e.parameter;
  const action = params.action;

  if (action === 'create') {
    sheet.appendRow([
      Date.now(), 
      params.title, 
      params.content, 
      params.author, 
      params.password, 
      new Date()
    ]);
    return ContentService.createTextOutput("Success")
      .setMimeType(ContentService.MimeType.TEXT);
  }
  
  if (action === 'delete') {
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      // data[i][0]은 ID, data[i][4]는 Password
      if (data[i][0] == params.id && data[i][4] == params.password) {
        sheet.deleteRow(i + 1);
        return ContentService.createTextOutput("Deleted")
          .setMimeType(ContentService.MimeType.TEXT);
      }
    }
    return ContentService.createTextOutput("Fail: Wrong Password")
      .setMimeType(ContentService.MimeType.TEXT);
  }
}