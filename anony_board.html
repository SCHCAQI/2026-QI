<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeValue - 우리가치 익명게시판</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* 테마 컬러를 보라색(#8a2be2)으로 통일 */
        :root { 
            --primary: #8a2be2; 
            --bg: #f8f9fa; 
            --text: #222; 
            --border: #eee; 
            --accent: #8a2be2; /* 추가 버튼 색상도 보라색으로 변경 */
        }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 80px; font-size: 17px; } 
        
        header { background: white; padding: 15px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        
        .header-logo { 
            width: 56px; height: 56px; vertical-align: middle; margin-right: 8px; object-fit: contain;
            mix-blend-mode: multiply; /* 이미지의 흰 배경을 투명하게 처리 */
        }
        
        .brand-name { font-size: 30px; font-weight: bold; vertical-align: middle; cursor: pointer; color: var(--primary); }
        
        .list-item { background: white; padding: 20px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .list-item:active { background: #f0f0f0; }
        .list-item .author-info { font-size: 15px; color: #888; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .list-item .title { font-size: 19px; font-weight: bold; margin-bottom: 5px; }
        .list-item .content-preview { font-size: 17px; color: #666; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        
        .version-tag { font-family: monospace; font-size: 13px; color: #aaa; background: #f0f0f0; padding: 2px 6px; border-radius: 4px; vertical-align: middle; }
        
        /* 추가 버튼(FAB) 스타일 수정 */
        .write-fab { 
            position: fixed; bottom: 30px; right: 25px; width: 65px; height: 65px; 
            background: var(--accent); color: white; border: none; border-radius: 50%; 
            font-size: 35px; font-weight: 300; display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 6px 16px rgba(138, 43, 226, 0.3); /* 보라색 그림자 */
            cursor: pointer; z-index: 100; transition: transform 0.2s; 
        }
        .write-fab:active { transform: scale(0.9); }
        
        .paging-bar { padding: 20px; text-align: center; background: white; font-size: 18px; border-top: 1px solid var(--border); }
        .paging-bar button { background: none; border: 1px solid var(--border); padding: 8px 18px; margin: 0 5px; border-radius: 5px; font-size: 16px; cursor: pointer; }
        .paging-bar button:disabled { opacity: 0.3; cursor: default; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input, textarea { width: 100%; border: 1px solid var(--border); padding: 12px; margin-bottom: 10px; border-radius: 8px; font-size: 18px; box-sizing: border-box; outline: none; }
        input:focus, textarea:focus { border-color: var(--primary); }
    </style>
</head>
<body>
<div id="app">
    <div v-if="isLoading" class="loading-overlay">
        <div class="spinner"></div>
        <div style="font-weight: bold; color: var(--primary);">처리 중...</div>
    </div>
    
    <header>
        <div @click="goHome" style="cursor:pointer;">
            <div style="display: flex; align-items: center;">
                <img src="wevalue_w.png" alt="Logo" class="header-logo">
                <span class="brand-name">우리가치(WeValue)</span>
            </div>
            <div style="font-size: 14px; color: #666; margin-top: 2px; padding-left: 64px;">
                <span class="version-tag" style="margin-left: 8px;">v20260225.10</span>
            </div>
            <div style="font-size: 14px; color: #666; margin-top: 2px; padding-left: 64px;">
                {{ viewMode === 'list' ? '전체글 목록' : (viewMode === 'write' ? '새 글 작성' : (viewMode === 'edit' ? '글 수정' : '상세보기')) }}
            </div>
        </div>
        <button v-if="viewMode !== 'list'" @click="handleBack" style="background:none; border:none; color: var(--primary); font-weight: bold; font-size: 17px; cursor:pointer;">뒤로</button>
    </header>
    
    <div v-if="viewMode === 'list'">
        <div class="search-bar" style="padding:10px; background:white;">
            <input v-model="searchQuery" placeholder="현재 페이지에서 검색..." style="margin:0;">
        </div>
        <div v-for="post in filteredPosts" :key="post.ID" class="list-item" @click="openDetail(post)">
            <div class="author-info">
                <span style="color:var(--primary)">??</span> {{ post.Author }} · {{ formatDate(post.Date) }}
            </div>
            <div class="title">{{ post.Title }}</div>
            <div class="content-preview">{{ post.Content }}</div>
        </div>
        <div class="paging-bar">
            <button :disabled="currentPage === 1" @click="changePage(currentPage - 1)">이전</button>
            <span>{{ currentPage }} / {{ totalPages }}</span>
            <button :disabled="currentPage >= totalPages" @click="changePage(currentPage + 1)">다음</button>
        </div>
        <button class="write-fab" @click="openWrite">+</button>
    </div>

    <div v-if="viewMode === 'write' || viewMode === 'edit'" class="modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 150; overflow-y: auto;">
        <div class="modal-header" style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white;">
            <button @click="handleBack" style="font-size: 17px; background:none; border:none; color: #666; cursor:pointer;">취소</button>
            <strong>{{ viewMode === 'write' ? '새 글 쓰기' : '글 수정' }}</strong>
            <button @click="viewMode === 'write' ? savePost() : updatePost()" style="color:var(--primary); font-weight:bold; font-size: 17px; background:none; border:none; cursor:pointer;">완료</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <input v-model="form.author" placeholder="닉네임" :disabled="viewMode === 'edit'">
            <input v-model="form.password" type="password" placeholder="비밀번호 (필수)">
            <input v-model="form.title" placeholder="제목">
            <textarea v-model="form.content" rows="15" placeholder="내용을 입력하세요."></textarea>
        </div>
    </div>

    <div v-if="viewMode === 'detail'" class="modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 150; overflow-y: auto;">
        <div class="modal-header" style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white;">
            <button @click="handleBack" style="font-size: 17px; background:none; border:none; color: var(--primary); cursor:pointer;">← 목록</button>
            <div v-if="form.author === myId">
                <button @click="viewMode = 'edit'" style="font-size: 17px; background:none; border:none; margin-right:12px; color: #666; cursor:pointer;">수정</button>
                <button @click="deletePost" style="color:#ff5a5f; font-size: 17px; background:none; border:none; cursor:pointer;">삭제</button>
            </div>
        </div>
        <div class="modal-body" style="padding: 25px;">
            <div style="font-size: 17px; margin-bottom: 15px; color: #888;"><b>{{ form.author }}</b> · {{ formatDate(form.date) }}</div>
            <h2 style="font-size: 26px; margin-bottom: 25px; line-height: 1.3;">{{ form.title }}</h2>
            <p style="font-size: 19px; line-height: 1.8; white-space: pre-wrap;">{{ form.content }}</p>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycby0Y2trjJGVx-K000NemLYfKlFvAQSaCJ9rMFJCVMe9tx2N-zJkGyE-T1trPxffAdJ3/exec';
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const posts = ref([]);
            const viewMode = ref('list');
            const isLoading = ref(false);
            const searchQuery = ref('');
            const currentPage = ref(1);
            const totalPages = ref(1);
            const myId = ref(localStorage.getItem('myAnonId') || '');
            const form = ref({ id: '', author: myId.value, title: '', content: '', password: '', date: '' });

            const updateHistory = () => {
                const state = { viewMode: viewMode.value, page: currentPage.value };
                history.pushState(state, '');
            };

            const fetchPosts = async () => {
                isLoading.value = true;
                try {
                    const res = await axios.get(`${API_URL}?action=read&page=${currentPage.value}`);
                    posts.value = res.data.posts || [];
                    totalPages.value = res.data.totalPages || 1;
                } catch(e) { console.error(e); }
                finally { isLoading.value = false; window.scrollTo(0,0); }
            };

            onMounted(() => {
                history.replaceState({ viewMode: 'list', page: 1 }, '');
                fetchPosts();
                window.onpopstate = (event) => {
                    if (event.state) {
                        viewMode.value = event.state.viewMode;
                        if (currentPage.value !== event.state.page) {
                            currentPage.value = event.state.page;
                            fetchPosts();
                        }
                    }
                };
            });

            const changePage = (p) => {
                currentPage.value = p;
                updateHistory();
                fetchPosts();
            };

            const openWrite = () => {
                form.value = { id: '', author: myId.value, title: '', content: '', password: '', date: '' };
                viewMode.value = 'write';
                updateHistory();
            };

            const openDetail = (post) => {
                form.value = { id: post.ID, author: post.Author, title: post.Title, content: post.Content, date: post.Date, password: '' };
                viewMode.value = 'detail';
                updateHistory();
            };

            const goHome = () => {
                if(viewMode.value === 'list' && currentPage.value === 1) return;
                viewMode.value = 'list';
                currentPage.value = 1;
                updateHistory();
                fetchPosts();
            };

            const handleBack = () => history.back();

            const savePost = async () => {
                if(!form.value.password || !form.value.title) return alert("비밀번호와 제목은 필수입니다.");
                isLoading.value = true;
                const p = new URLSearchParams();
                p.append('action', 'create');
                p.append('author', form.value.author || '익명');
                p.append('password', form.value.password);
                p.append('title', form.value.title);
                p.append('content', form.value.content);
                try {
                    await axios.post(API_URL, p);
                    localStorage.setItem('myAnonId', form.value.author);
                    myId.value = form.value.author;
                    viewMode.value = 'list';
                    currentPage.value = 1;
                    await fetchPosts();
                } catch(e) { alert("저장 실패"); isLoading.value = false; }
            };

            const updatePost = async () => {
                isLoading.value = true;
                const p = new URLSearchParams();
                p.append('action', 'update');
                p.append('id', form.value.id);
                p.append('password', form.value.password);
                p.append('title', form.value.title);
                p.append('content', form.value.content);
                try {
                    const res = await axios.post(API_URL, p);
                    if(res.data === 'Updated') { 
                        viewMode.value = 'list'; 
                        await fetchPosts(); 
                    } else { alert("비밀번호가 일치하지 않습니다."); isLoading.value = false; }
                } catch(e) { alert("수정 실패"); isLoading.value = false; }
            };

            const deletePost = async () => {
                const pw = prompt("삭제를 위해 비밀번호를 입력하세요.");
                if(!pw) return;
                isLoading.value = true;
                const p = new URLSearchParams();
                p.append('action', 'delete');
                p.append('id', form.value.id);
                p.append('password', pw);
                try {
                    const res = await axios.post(API_URL, p);
                    if(res.data === 'Deleted') { 
                        viewMode.value = 'list'; 
                        await fetchPosts(); 
                    } else { alert("비밀번호 불일치 또는 이미 삭제된 글입니다."); isLoading.value = false; }
                } catch(e) { alert("삭제 실패"); isLoading.value = false; }
            };

            const formatDate = (dateStr) => {
                const d = new Date(dateStr);
                return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            };

            const filteredPosts = computed(() => {
                if(!searchQuery.value) return posts.value;
                const q = searchQuery.value.toLowerCase();
                return posts.value.filter(p => String(p.Title).toLowerCase().includes(q) || String(p.Content).toLowerCase().includes(q));
            });

            return { posts, viewMode, isLoading, searchQuery, form, myId, currentPage, totalPages, filteredPosts, openDetail, openWrite, changePage, handleBack, goHome, savePost, updatePost, deletePost, formatDate };
        }
    }).mount('#app');
</script>
</body>
</html>