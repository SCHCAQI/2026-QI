<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeValue - 우리가치 칭찬게시판</title>
    <link rel="icon" href="wevalue_w.png" type="image/png">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root { 
            --primary: #8a2be2; 
            --bg: #f8f9fa; 
            --header-bg: #ffffff;
            --card-bg: #ffffff;
            --text: #222; 
            --text-light: #666;
            --border: #eee; 
            --input-bg: #ffffff;
            --overlay: rgba(255, 255, 255, 0.7);
        }

        [data-theme='dark'] {
            --bg: #121212;
            --header-bg: #1e1e1e;
            --card-bg: #1e1e1e;
            --text: #e0e0e0;
            --text-light: #aaa;
            --border: #333;
            --input-bg: #2a2a2a;
            --overlay: rgba(0, 0, 0, 0.7);
        }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; color: var(--text); padding-bottom: 80px; transition: background 0.3s, color 0.3s; } 
        header { background: var(--header-bg); padding: 15px; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
        .header-logo { width: 56px; height: 56px; object-fit: contain; margin-right: 8px; }
        [data-theme='light'] .header-logo { mix-blend-mode: multiply; }
        .brand-name { font-size: 26px; font-weight: bold; color: var(--primary); }
        .list-item { background: var(--card-bg); padding: 20px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .list-item:active { background: var(--border); }
        .list-item .author-info { font-size: 14px; color: var(--text-light); margin-bottom: 5px; }
        .list-item .title { font-size: 18px; font-weight: bold; margin-bottom: 5px; color: var(--text); }
        .list-item .content-preview { font-size: 16px; color: var(--text-light); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .version-tag { font-size: 12px; color: var(--text-light); background: var(--bg); padding: 2px 6px; border-radius: 4px; }
        .write-fab { position: fixed; bottom: 30px; right: 25px; width: 60px; height: 60px; background: var(--primary); color: white; border: none; border-radius: 50%; font-size: 30px; box-shadow: 0 4px 12px rgba(138, 43, 226, 0.3); z-index: 100; cursor: pointer; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--overlay); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        input, textarea { width: 100%; border: 1px solid var(--border); padding: 12px; margin-bottom: 10px; border-radius: 8px; background: var(--input-bg); color: var(--text); box-sizing: border-box; outline: none; }
        .theme-btn { background: none; border: none; font-size: 22px; cursor: pointer; padding: 5px; margin-right: 10px; transition: transform 0.2s; }
        .theme-btn:active { transform: scale(1.2); }
    </style>
</head>
<body>
<div id="app">
    <div v-if="isLoading" class="loading-overlay">
        <div class="spinner"></div>
        <div style="margin-top:10px; font-weight:bold; color:var(--primary);">로딩 중...</div>
    </div>
    
    <header>
        <div @click="goHome" style="cursor:pointer; flex:1;">
            <div style="display: flex; align-items: center;">
                <img src="wevalue_w.png" alt="Logo" class="header-logo">
                <span class="brand-name">우리가치(WeValue)</span>
                <span class="brand-name">칭찬게시판</span>
            </div>
            <div style="font-size: 12px; color: var(--text-light); padding-left: 64px;">
                <span class="version-tag">v2026.02.25</span>
                <span style="margin-left:8px;">{{ viewMode === 'list' ? '목록' : '글보기' }}</span>
            </div>
        </div>
        
        <div style="display: flex; align-items: center;">
            <button @click="toggleTheme" class="theme-btn">{{ isDarkMode ? 'LIGHT' : 'DARK' }}</button>
            <button v-if="viewMode !== 'list'" @click="handleBack" style="background:none; border:none; color:var(--primary); font-weight:bold; font-size:16px; cursor:pointer;">뒤로</button>
        </div>
    </header>

    <div v-if="viewMode === 'list'">
        <div style="padding:10px; background:var(--card-bg);">
            <input v-model="searchQuery" placeholder="게시글 검색...">
        </div>
        <div v-for="post in filteredPosts" :key="post.ID" class="list-item" @click="openDetail(post)">
            <div class="author-info">{{ post.Author }} · {{ formatDate(post.Date) }}</div>
            <div class="title">{{ post.Title }}</div>
            <div class="content-preview">{{ post.Content }}</div>
        </div>
        <div style="padding:20px; text-align:center; background:var(--card-bg); border-top:1px solid var(--border);">
            <button :disabled="currentPage === 1" @click="changePage(currentPage - 1)">이전</button>
            <span style="margin:0 15px;">{{ currentPage }} / {{ totalPages }}</span>
            <button :disabled="currentPage >= totalPages" @click="changePage(currentPage + 1)">다음</button>
        </div>
        <button class="write-fab" @click="openWrite">+</button>
    </div>

    <div v-if="viewMode === 'write' || viewMode === 'edit'" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--card-bg); z-index:150; overflow-y:auto;">
        <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--header-bg); position:sticky; top:0;">
            <button @click="handleBack" style="background:none; border:none; color:var(--text-light); cursor:pointer;">취소</button>
            <strong style="color:var(--text)">{{ viewMode === 'write' ? '새 글 작성' : '수정하기' }}</strong>
            <button @click="viewMode === 'write' ? savePost() : updatePost()" style="background:none; border:none; color:var(--primary); font-weight:bold; cursor:pointer;">완료</button>
        </div>
        <div style="padding:20px;">
            <input v-model="form.author" placeholder="닉네임" :disabled="viewMode === 'edit'">
            <input v-model="form.password" type="password" placeholder="비밀번호">
            <input v-model="form.title" placeholder="제목을 입력하세요">
            <textarea v-model="form.content" rows="15" placeholder="내용을 입력하세요"></textarea>
        </div>
    </div>

    <div v-if="viewMode === 'detail'" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--card-bg); z-index:150; overflow-y:auto;">
        <div style="padding:15px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--header-bg); position:sticky; top:0;">
            <button @click="viewMode = 'list'" style="background:none; border:none; color:var(--primary); cursor:pointer;">목록</button>
            <div v-if="form.author === myId">
                <button @click="viewMode = 'edit'" style="background:none; border:none; color:var(--text-light); margin-right:10px; cursor:pointer;">수정</button>
                <button @click="deletePost" style="background:none; border:none; color:#ff5a5f; cursor:pointer;">삭제</button>
            </div>
        </div>
        <div style="padding:25px;">
            <div style="color:var(--text-light); margin-bottom:10px;">{{ form.author }} · {{ formatDate(form.date) }}</div>
            <h2 style="color:var(--text); line-height:1.4;">{{ form.title }}</h2>
            <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
            <p style="color:var(--text); line-height:1.8; white-space:pre-wrap;">{{ form.content }}</p>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycby0Y2trjJGVx-K000NemLYfKlFvAQSaCJ9rMFJCVMe9tx2N-zJkGyE-T1trPxffAdJ3/exec';
    const CACHE_KEY = 'wevalue_posts_cache';
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const posts = ref([]);
            const viewMode = ref('list');
            const isLoading = ref(false);
            const searchQuery = ref('');
            const currentPage = ref(1);
            const totalPages = ref(1);
            const isDarkMode = ref(false);
            const myId = ref(localStorage.getItem('myAnonId') || '');
            const form = ref({ id: '', author: myId.value, title: '', content: '', password: '', date: '' });

            const toggleTheme = () => {
                isDarkMode.value = !isDarkMode.value;
                const mode = isDarkMode.value ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', mode);
                localStorage.setItem('wevalue_theme', mode);
            };

            const fetchPosts = async (useCache = true) => {
                if (useCache && currentPage.value === 1) {
                    const cached = localStorage.getItem(CACHE_KEY);
                    if (cached) posts.value = JSON.parse(cached);
                }
                isLoading.value = true;
                try {
                    const res = await axios.get(`${API_URL}?action=read&page=${currentPage.value}`);
                    posts.value = res.data.posts || [];
                    totalPages.value = res.data.totalPages || 1;
                    if (currentPage.value === 1) localStorage.setItem(CACHE_KEY, JSON.stringify(posts.value));
                } catch(e) { console.error(e); } finally { isLoading.value = false; window.scrollTo(0,0); }
            };

            onMounted(() => {
                const savedTheme = localStorage.getItem('wevalue_theme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    isDarkMode.value = true;
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
                fetchPosts();
            });

            const changePage = (p) => { currentPage.value = p; fetchPosts(); };
            const openWrite = () => { form.value = { id: '', author: myId.value, title: '', content: '', password: '', date: '' }; viewMode.value = 'write'; };
            const openDetail = (post) => { form.value = { id: post.ID, author: post.Author, title: post.Title, content: post.Content, date: post.Date, password: '' }; viewMode.value = 'detail'; };
            const goHome = () => { viewMode.value = 'list'; currentPage.value = 1; fetchPosts(); };
            const handleBack = () => { viewMode.value = 'list'; };

            const savePost = async () => {
                if (!form.value.title || !form.value.content) {
                    alert("제목과 내용을 입력해주세요.");
                    return;
                }
            
                isLoading.value = true;
                
                // URLSearchParams 사용
                const params = new URLSearchParams();
                params.append('action', 'create');
                params.append('author', form.value.author || '칭찬');
                params.append('password', form.value.password);
                params.append('title', form.value.title);
                params.append('content', form.value.content);
            
                try {
                    // GAS는 POST 후 302 리다이렉트를 하므로, 브라우저가 이를 잘 따라가도록 처리해야 합니다.
                    // axios는 기본적으로 따르지만, 헤더 충돌을 방지하기 위해 아래와 같이 구성합니다.
                    const res = await axios({
                        method: 'post',
                        url: API_URL,
                        data: params,
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    });
            
                    localStorage.setItem('myAnonId', form.value.author);
                    myId.value = form.value.author;
                    viewMode.value = 'list';
                    fetchPosts(false);
                } catch (e) {
                    console.error("에러 상세:", e);
                    // 네트워크 에러인지, GAS 내부 에러인지 확인을 위해 e.message를 띄웁니다.
                    alert("저장 실패: " + (e.response?.data?.message || "네트워크 연결이나 GAS 설정을 확인하세요."));
                } finally {
                    isLoading.value = false;
                }
            };

            const updatePost = async () => { /* 수정 로직... */ };
            const deletePost = async () => { /* 삭제 로직... */ };
            const formatDate = (dateStr) => {
                const d = new Date(dateStr);
                return `${d.getMonth()+1}/${d.getDate()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            };

            const filteredPosts = computed(() => {
                if(!searchQuery.value) return posts.value;
                const q = searchQuery.value.toLowerCase();
                return posts.value.filter(p => String(p.Title).toLowerCase().includes(q) || String(p.Content).toLowerCase().includes(q));
            });

            return { posts, viewMode, isLoading, searchQuery, form, myId, currentPage, totalPages, isDarkMode, filteredPosts, toggleTheme, openDetail, openWrite, changePage, handleBack, goHome, savePost, updatePost, deletePost, formatDate };
        }
    }).mount('#app');
</script>
</body>
</html>